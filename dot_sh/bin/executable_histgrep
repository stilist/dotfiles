#!/usr/bin/env bash

set -euo pipefail
IFS=$'\n\t'

###
# `histgrep`
#
# Search the history files created by `session/history.sh`.
#
# @example Find all history matching 'ssh'
#   histgrep ssh
# @example Display the most recent command in history matching 'ssh'
#   histgrep ssh | grep -v histgrep | tail -1 | cut -d ' ' -f 2-
# @see https://twitter.com/michaelhoffman/status/639226401015525376
# @see https://stackoverflow.com/a/981831/672403
###

export GREP_COLOR='1;33' # yellow
# `--text`: https://utcc.utoronto.ca/~cks/space/blog/unix/GNUGrepForceText
export GREP_OPTIONS="--color=always --ignore-case --regexp=$@ --text"

DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
HISTORY_PATH="${DATA_HOME}/history-data/automated imports/shell"

sorter_path="$(dirname "$0")/../support/histgrep_sort.rb"

matches() {
  grep --recursive \
    -S \
    "${HISTORY_PATH}"
}

# `grep`: search files for matches
# `sed`: remove directory name from output
# `ruby`: sort lines by file timestamp
# `awk`: colorize filename and add space between colon and match
"$(matches)" |
  sed s:"$HISTORY_PATH/":: |
  ruby --disable-gems "$sorter_path" |
  awk -F ':' -v VIOLET='\033[1;35m' -v RESET='\033[0m' \
    '{ print VIOLET $1 RESET FS " " substr($0, index($0, $2)) }'
