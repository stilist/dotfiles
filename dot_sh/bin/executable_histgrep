#!/usr/bin/env bash

set -euo pipefail
IFS=$'\n\t'

###
# `histgrep`
#
# Search the history files created by `session/history.sh`.
#
# @example Find all history matching 'ssh'
#   histgrep ssh
# @example Display the most recent command in history matching 'ssh'
#   histgrep ssh | grep -v histgrep | tail -1 | cut -d ' ' -f 2-
# @see https://twitter.com/michaelhoffman/status/639226401015525376
# @see https://stackoverflow.com/a/981831/672403
###

query_pattern="${@:?}"

export GREP_COLOR='1;33' # yellow

DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
HISTORY_PATH="${DATA_HOME}/history-data/automated imports/shell"

my_name="$(basename "${0}")"
usage="$(cat <<EOM
Search and filter shell command history. Use this together with \e[1msession/history.sh\e[0m.

Usage: ${my_name} QUERY

Flags:
\t-h\tdisplay this help message

Example:
\t${my_name} ssh
\t${my_name} 'ln -s'
\t${my_name} '\\\b[[:alpha:]]at\\\b' # matches both 'bat' and 'cat' tools
EOM
)"

while getopts 'h' OPTION ; do
  case "${OPTION}" in
  h)
    echo -e "${usage}"
    exit 0
    ;;
  ?)
    echo -e "${usage}"
    exit 1
    ;;
  esac
done

matches() {
  # `-S`: follow symbolic links in recursive mode
  # `--text`: https://utcc.utoronto.ca/~cks/space/blog/unix/GNUGrepForceText
  grep \
    --color=always \
    --ignore-case \
    --recursive \
    --regexp="${@}" \
    -S \
    --text \
    "${HISTORY_PATH}"
}

sorter_path="$(dirname "$0")/../support/histgrep_sort.rb"

# `grep`: search files for matches
# `sed`: remove directory name from output
# `ruby`: sort lines by file timestamp
# `awk`: colorize filename and add space between colon and match
matches "${query_pattern}" \
  | sed s:"$HISTORY_PATH/":: \
  | ruby --disable-gems "$sorter_path" \
  | awk -F ':' -v VIOLET='\033[1;35m' -v RESET='\033[0m' \
    '{ print VIOLET $1 RESET FS " " substr($0, index($0, $2)) }'
