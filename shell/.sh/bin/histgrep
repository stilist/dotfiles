#!/usr/bin/env bash

set -euo pipefail
IFS=$'\n\t'

###
# `histgrep`
#
# Search the history files created by `session/history.sh`.
#
# @example
#   histgrep ssh
#
# @see https://twitter.com/michaelhoffman/status/639226401015525376
# @see https://stackoverflow.com/a/981831/672403
###

export GREP_COLOR='1;33' # yellow
export GREP_OPTIONS="--color=always --ignore-case --regexp=$*"
HISTORY_PATH="${HOME}/.history"

sorter_path="$(dirname "$0")/../support/histgrep_sort.rb"

# `grep`: search files for matches
# `sed`: remove directory name from output
# `ruby`: sort lines by file timestamp
# `awk`: colorize filename and add space between colon and match
grep --recursive -S "${HISTORY_PATH}" |
  sed s:"$HISTORY_PATH/":: |
  ruby --disable-gems "$sorter_path" |
  awk -F ':' -v VIOLET='\033[1;35m' -v RESET='\033[0m' \
    '{ print VIOLET $1 RESET FS " " substr($0, index($0, $2)) }'
